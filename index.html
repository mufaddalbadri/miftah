<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد القافية العربية (Qafiya Generator)</title>
    <!-- PWA Setup: Link to Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Setup: General Icon Link -->
    <link rel="shortcut icon" href="icons/icon-192.png">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Arabic font and centered text */
        /* Importing fonts: Reem Kufi for title, Amiri for body */
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Reem+Kufi:wght@700&display=swap');
        body {
            font-family: 'Amiri', serif;
            /* Rich English Blue background: #0f4c81 */
            background-color: #0f4c81; 
            direction: rtl; /* Set base direction to Right-to-Left */
            text-align: right;
            transition: background-color 0.3s;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
        }
        /* Style for the generated list */
        #results-list {
            list-style-type: none;
            padding-right: 0;
            margin-right: 0;
            display: grid;
            /* Adjusted to ensure 3 columns fit within the max-width: 150px min width favors 3 columns in 512px container */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 0.75rem;
        }
        /* Ensure all list items (words) have consistent styling - Now designed as 'catchy cards' */
        #results-list li {
            /* Enhanced Background: Subtle gradient */
            background: linear-gradient(145deg, #ffffff, #f4faff); 
            border: none; /* Removing border to rely on shadow/gradient */
            padding: 1.2rem; 
            margin-bottom: 0;
            border-radius: 1rem; /* Slightly larger border-radius */
            /* Smoother transition for hover effect */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            
            box-sizing: border-box; 
            min-height: 5rem; /* Fixed height for better visual consistency */
            display: flex; /* Use flex to center content vertically */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
            
            font-size: 1.35rem; 
            font-weight: 700;
            /* Stronger, but softer shadow for 3D card effect */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            cursor: pointer; 
            grid-column: span 1; 
        }
        #results-list li:hover {
            background: #e6f1ff; /* Solid light blue color on hover */
            transform: translateY(-3px) scale(1.02); /* More dynamic lift and slight scale */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* Deeper shadow on hover */
        }
        /* Custom focus style for input */
        input:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(100, 180, 255, 0.5); /* Lighter blue glow */
        }
        /* Kufi-inspired Title Style */
        .title-kufi {
            font-family: 'Reem Kufi', sans-serif; /* Modern Kufi font */
            text-shadow: 1px 1px 3px #bbdefb; /* Light blue shadow for sleek effect */
            letter-spacing: 1px;
        }
        /* Style for the dynamically inserted meaning popup - Enhanced visibility */
        .meaning-popup {
            grid-column: 1 / -1; /* Make the popup span the full width of the grid */
            background-color: #e3f2fd; /* Light, prominent blue */
            border: 1px solid #90caf9; /* Soft blue border */
            animation: fadeIn 0.3s ease-out;
            text-align: right; /* Ensure content inside popup is right-aligned */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom CSS to increase input font size */
        #wordInput {
            font-size: 1.5rem; /* Larger font size for the input text */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#3b82f6',
                        'primary-dark': '#1e40af',
                        'english-blue': '#0f4c81',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="container bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg relative">
        
        <!-- Main Title: Increased margin-bottom to add space after h1 -->
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center title-kufi text-english-blue mb-6 sm:mb-8">المفتاح</h1>
        <!-- Sub-Title: Decreased margin-bottom to remove the large space after h2 -->
        <h2 class="text-xl sm:text-2xl font-bold text-center text-gray-700 mb-4 sm:mb-6">المعاني والقوافي</h2>

        <!-- Input Section -->
        <div class="space-y-4">
            <input
                type="text"
                id="wordInput"
                placeholder="مثال: مفضل"
                class="w-full p-4 border-2 border-gray-300 rounded-lg text-lg text-center transition duration-300 focus:border-primary-blue"
                maxlength="50"
            />
            
            <!-- Buttons Group: Two buttons now side-by-side -->
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                <button
                    id="generateButton"
                    class="w-full sm:w-1/2 bg-english-blue text-white py-3 rounded-lg text-xl font-bold hover:bg-primary-dark transition duration-300 shadow-lg active:scale-95 disabled:opacity-50"
                >
                    البحث عن القافية
                </button>
                <button
                    id="searchMeaningButton"
                    class="w-full sm:w-1/2 bg-gray-500 text-white py-3 rounded-lg text-xl font-bold hover:bg-gray-600 transition duration-300 shadow-lg active:scale-95 disabled:opacity-50"
                >
                    البحث عن المعنى
                </button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultsArea" class="mt-8">
            <h2 id="resultsTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center hidden">نتائج القافية:</h2>
            <!-- NEW INSTRUCTION LINE ADDED HERE -->
            <p id="clickInstruction" class="text-center text-gray-500 text-sm mb-4 hidden">انقر على أي كلمة لعرض معناها.</p> 

            <div id="loading" class="text-center text-english-blue hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-english-blue border-gray-200 rounded-full"></div>
                <p class="mt-2 text-lg">جارٍ البحث عن القوافي...</p>
            </div>
            
            <ul id="results-list" class="space-y-3">
                <!-- Rhyming words and meanings will be inserted here -->
            </ul>

            <div id="messageBox" class="text-center mt-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-300 hidden">
                <!-- Error messages will appear here -->
            </div>
        </div>

        <!-- New Footer Section -->
        <footer class="mt-8 pt-4 border-t border-gray-200 text-center text-xs text-gray-500">
            NujoomApps - Al-Manzoom | Sh Mufaddal Sh Zohair
        </footer>
    </div>

    <script type="module">
        const wordInput = document.getElementById('wordInput');
        const generateButton = document.getElementById('generateButton');
        const searchMeaningButton = document.getElementById('searchMeaningButton'); // New button element
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsList = document.getElementById('results-list');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('messageBox');
        const clickInstruction = document.getElementById('clickInstruction');
        
        // --- Core LLM Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL_BASE = "https://old-pond-c01d.mufaddalbadr.workers.dev";

        /**
         * Converts the input text into a clean HTML list item.
         * @param {string} text - The raw text from the LLM.
         */
        function formatResults(text) {
            let items = text.split('\n').map(item => item.trim());
            items = items
                .filter(item => item.length > 0)
                .map(item => item.replace(/^[0-9\.\-\*]\s*/, '').trim())
                .filter(item => item.length > 0);

            resultsList.innerHTML = items.map(word => `<li class="hover:bg-blue-50">${word}</li>`).join('');
        }

        /**
         * Handles the API call to generate rhymes using the Gemini model.
         */
        async function getRhymes() {
            const word = wordInput.value.trim();
            if (!word) {
                showMessage("الرجاء إدخال كلمة عربية للبحث عن القافية.", 'bg-yellow-100 text-yellow-700 border-yellow-300');
                return;
            }

            // Clear previous results, messages, and meaning popups
            resultsList.innerHTML = '';
            resultsTitle.classList.add('hidden');
            clickInstruction.classList.add('hidden'); 
            showMessage('', '', true);
            document.querySelectorAll('.meaning-popup').forEach(el => el.remove());


            // Show loading state (Global loader with Qafiya text)
            loading.classList.remove('hidden');
            generateButton.disabled = true;
            searchMeaningButton.disabled = true; // Disable both buttons

            const systemPrompt = `You are an expert in Arabic language and poetry (Qafiya). Your task is to generate a list of at least 40 Arabic words that share the exact 'Qafiya' (rhyme scheme, typically matching the last two consonants and their preceding vowel) of the user's input word. Respond ONLY with the UNNUMBERED list of words, one word per line, without any other conversational text or explanation.`;

            const userQuery = `Generate rhyming words (Qafiya) for the Arabic word: ${word}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(API_URL_BASE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const generatedText = candidate.content.parts[0].text;
                        formatResults(generatedText);
                        resultsTitle.classList.remove('hidden');
                        clickInstruction.classList.remove('hidden');
                        break;
                    } else {
                        throw new Error('No content generated by the model.');
                    }
                } catch (error) {
                    console.error("API Call Error:", error);
                    currentRetry++;
                    if (currentRetry >= maxRetries) {
                        showMessage('حدث خطأ أثناء الاتصال بالخادم. حاول مرة أخرى.', 'bg-red-100 text-red-700 border-red-300');
                    } else {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, currentRetry) * 1000));
                    }
                } finally {
                    if (currentRetry >= maxRetries || resultsList.children.length > 0) {
                        loading.classList.add('hidden');
                        generateButton.disabled = false;
                        searchMeaningButton.disabled = false; // Re-enable both buttons
                    }
                }
            }
        }
        
        /**
         * New function to trigger meaning search directly from the input field.
         */
        async function searchMeaningFromInput() {
            const word = wordInput.value.trim();
            if (!word) {
                showMessage("الرجاء إدخال كلمة عربية للبحث عن معناها.", 'bg-yellow-100 text-yellow-700 border-yellow-300');
                return;
            }
            
            // Clear previous UI elements
            resultsList.innerHTML = '';
            resultsTitle.classList.add('hidden');
            clickInstruction.classList.add('hidden'); 
            showMessage('', '', true);
            document.querySelectorAll('.meaning-popup').forEach(el => el.remove());
            
            // --- MODIFICATION HERE: We only disable buttons, but DO NOT show the global #loading element.
            // --- The meaning loader is self-contained within the meaning-popup.
            // loading.classList.remove('hidden'); // REMOVED
            generateButton.disabled = true;
            searchMeaningButton.disabled = true;

            // Call getWordMeaning, passing null for listItem to indicate insertion directly into resultsList
            await getWordMeaning(word, null);
            
            // loading.classList.add('hidden'); // REMOVED
            generateButton.disabled = false;
            searchMeaningButton.disabled = false;
        }


        /**
         * Fetches and displays the short Arabic meaning and a sample sentence of a word, inserting it dynamically.
         * @param {string} word - The word to look up.
         * @param {HTMLElement | null} listItem - The <li> element to insert the meaning after (or null for direct search).
         */
        async function getWordMeaning(word, listItem) {
            // 1. Clear all existing meaning displays
            document.querySelectorAll('.meaning-popup').forEach(el => el.remove());
            
            // 2. Create the dynamic meaning popup element with a loading spinner
            const popup = document.createElement('div');
            popup.className = 'meaning-popup col-span-full text-center mt-2 p-4 text-gray-800 rounded-lg shadow-md';
            
            // Initial HTML with loading state (This loader has the correct text)
            popup.innerHTML = `
                <p class="font-bold text-2xl mb-4 text-english-blue">${word}</p>
                <div class="space-y-4">
                    <!-- Loading State -->
                    <div class="text-center text-primary-blue mt-2">
                        <div class="animate-spin inline-block w-4 h-4 border-2 border-t-primary-blue border-gray-200 rounded-full"></div>
                        <p class="text-sm text-gray-500 mt-1">جاري جلب المعنى والمثال...</p>
                    </div>
                </div>
            `;
            
            // Insertion Logic:
            if (listItem) {
                // If triggered by clicking an LI: insert after it
                listItem.parentNode.insertBefore(popup, listItem.nextSibling);
            } else {
                // If triggered by the main button: insert directly into the results list (cleared beforehand)
                resultsList.appendChild(popup);
            }

            // 3. Setup JSON Schema
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "definition": { "type": "STRING", "description": "A very short and concise definition of the word in Arabic." },
                    "sample_sentence": { "type": "STRING", "description": "A short, complete sample sentence in modern, standard Arabic (Fusha) that uses the defined word." }
                },
                required: ["definition", "sample_sentence"]
            };

            // 4. Setup System Prompt and Payload
            const systemPromptMeaning = `You are an Arabic dictionary and linguist. Your task is to provide the definition and a sample sentence for the user's word. Your response MUST be a JSON object that adheres exactly to the provided schema. Do not include any conversational text outside the JSON object.`;
            const userQueryMeaning = `Provide the definition and a sample sentence for the Arabic word: ${word}`;

            const payload = {
                contents: [{ parts: [{ text: userQueryMeaning }] }],
                systemInstruction: { parts: [{ text: systemPromptMeaning }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetch(API_URL_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Meaning API call failed');

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) throw new Error('No JSON content generated.');

                const parsedJson = JSON.parse(jsonText);
                const { definition, sample_sentence } = parsedJson;
                
                if (!definition || !sample_sentence) throw new Error('Incomplete data received.');

                // 5. Highlighting Logic
                const highlightedWord = `<strong class="text-primary-dark font-extrabold bg-yellow-100 px-1 rounded">${word}</strong>`;
                
                // Simple string replacement for highlighting
                const highlightedSentence = sample_sentence.replace(word, highlightedWord);


                // 6. Update Popup UI with results
                popup.innerHTML = `
                    <p class="font-bold text-2xl mb-4 text-english-blue">${word}</p>
                    <div class="space-y-4 text-right">
                        <!-- Definition -->
                        <div>
                            <p class="font-semibold text-base text-gray-600 border-b pb-1 mb-1">المعنى:</p>
                            <p class="text-xl meaning-definition text-gray-900 leading-relaxed">${definition.trim()}</p>
                        </div>
                        <!-- Sample Sentence -->
                        <div>
                            <p class="font-semibold text-base text-gray-600 border-b pb-1 mb-1">جملة مثال:</p>
                            <p class="text-xl meaning-sentence text-gray-800 italic leading-relaxed">${highlightedSentence.trim()}</p>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error("Meaning/Sentence API Error:", error);
                // Display error in the popup
                popup.innerHTML = `<p class="font-bold text-2xl mb-4 text-english-blue">${word}</p><p class="text-lg text-red-600 mt-2">حدث خطأ في جلب المعنى والمثال.</p>`;
            }
        }

        /**
         * Displays a temporary message in the message box.
         */
        function showMessage(msg, classes, clearOnly = false) {
            messageBox.classList.add('hidden');
            if (clearOnly || !msg) {
                messageBox.innerHTML = '';
                messageBox.className = 'text-center mt-4 p-3 rounded-lg border hidden';
                return;
            }
            messageBox.innerHTML = msg;
            messageBox.className = `text-center mt-4 p-3 rounded-lg border ${classes}`;
            messageBox.classList.remove('hidden');
        }


        // Event Listeners
        generateButton.addEventListener('click', getRhymes);
        searchMeaningButton.addEventListener('click', searchMeaningFromInput); // New event listener

        wordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                // Now calls searchMeaningFromInput() instead of getRhymes()
                searchMeaningFromInput(); 
            }
        });

        // Event listener for clicking on a rhyming word
        resultsList.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI' && e.target.closest('#results-list')) {
                const selectedWord = e.target.textContent.trim();
                getWordMeaning(selectedWord, e.target);
            }
        });

        // Initial setup for the user on load
        window.onload = () => {
             showMessage("يرجى إدخال كلمة للبدء في البحث عن القوافي أو المعنى.", 'bg-blue-100 text-blue-700 border-blue-300');
        };

    </script>
</body>

</html>
